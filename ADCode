package com.ad.main;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.naming.NamingException;
import javax.naming.directory.DirContext;

import oracle.iam.platform.OIMClient;
import oracle.iam.scheduler.api.SchedulerService;
import oracle.iam.scheduler.vo.JobDetails;
import oracle.iam.scheduler.vo.JobParameter;

public class ADGroupMembershipJob {
	private static DirContext ldapContext = null;
	private static Map<String, Set<String>> adGroupMembers = null;
	private static Map<String, Set<String>> oimGroupMembers = null;
	private static Set<String> updatedGroups = null;
	private static Set<String> unCorrelatedAccounts = null;
	private static StringBuffer adReconFilter = null;

	public static void main(String args[]) throws Exception {
		ADOperations adOprs = null;
		String base_dn = null;
		Integer latestUSNChanged = null;
		HashMap<String, Object> updatedGroupsMap = null;
		long itResourcekey;

		String itResourceName = "Active Directory";
		Integer uSNChanged = 21600000;

		// OIMClient Connection
		OIMClient oimClient = ConnectionUtils.getOIMConnection();

		adOprs = new ADOperations();
		itResourcekey = ITResourceUtils.getItResource(itResourceName, oimClient);
		ldapContext = ConnectionUtils.connectToLDAP(itResourcekey, oimClient);
		base_dn = ITResourceUtils.findITResParamFromKey(itResourcekey, "Container", oimClient);
		updatedGroupsMap = adOprs.getAllUpdatedGroups(uSNChanged, ldapContext, base_dn);
		if (updatedGroupsMap != null) {
			latestUSNChanged = (Integer) updatedGroupsMap.get("Latest USNChanged");
			updatedGroups = (Set<String>) updatedGroupsMap.get("Updated Groups");
			ADGroupMembershipJob.updateScheduledJobParameter("Active Directory Group Recon", "Latest uSNChanged Token",latestUSNChanged.toString(), oimClient);
			System.out.println(latestUSNChanged);
		}
	}

	public static void main1(String args[]) throws Exception {
		ADOperations adOprs = null;
		OIMOperations oimOprs = null;
		String base_dn = null;
		Integer latestUSNChanged = null;
		HashMap<String, Object> updatedGroupsMap = null;
		long itResourcekey;

		String itResourceName = "Active Directory";
		Integer uSNChanged = 21636400;

		// OIMClient Connection
		OIMClient oimClient = ConnectionUtils.getOIMConnection();

		adOprs = new ADOperations();
		oimOprs = new OIMOperations();
		itResourcekey = ITResourceUtils.getItResource(itResourceName, oimClient);
		ldapContext = ConnectionUtils.connectToLDAP(itResourcekey, oimClient);
		base_dn = ITResourceUtils.findITResParamFromKey(itResourcekey, "Container", oimClient);
		updatedGroupsMap = adOprs.getAllUpdatedGroups(uSNChanged, ldapContext, base_dn);
		if (updatedGroupsMap != null) {
			latestUSNChanged = (Integer) updatedGroupsMap.get("Latest USNChanged");
			updatedGroups = (Set<String>) updatedGroupsMap.get("Updated Groups");
			if (updatedGroups != null && updatedGroups.size() > 0) {
				adGroupMembers = adOprs.getADMembershipData(updatedGroups, ldapContext, base_dn);
				oimGroupMembers = oimOprs.getOIMMembershipData(updatedGroups, itResourcekey, oimClient);
				unCorrelatedAccounts = oimOprs.compareADToOIM(adGroupMembers, oimGroupMembers, oimClient);
				System.out.println(unCorrelatedAccounts);
				if (unCorrelatedAccounts.size() > 0 && unCorrelatedAccounts.size() < 46) {
					adReconFilter = oimOprs.adUserReconFilter(new ArrayList<>(unCorrelatedAccounts));
					//ADGroupMembershipJob.updateScheduledJobParameter("", "Latest uSNChanged Token",
							//latestUSNChanged.toString(), oimClient);
					ADGroupMembershipJob.updateScheduledJobParameter("Active Directory Group Recon", "Filter", adReconFilter.toString(), oimClient);
					ADGroupMembershipJob.updateScheduledJobParameter("Active Directory Group Recon", "Latest Token", "",
							oimClient);

				} else {
					List<String> latestUnCorrelatedAccounts = new ArrayList<>(unCorrelatedAccounts).subList(0, 45);
					adReconFilter = oimOprs.adUserReconFilter(latestUnCorrelatedAccounts);
					unCorrelatedAccounts.removeAll(latestUnCorrelatedAccounts);

					ADGroupMembershipJob.updateScheduledJobParameter("Active Directory Group Recon", "Filter", adReconFilter.toString(), oimClient);
					ADGroupMembershipJob.updateScheduledJobParameter("Active Directory Group Recon", "Latest Token", "",
							oimClient);
				}

			}
		}
		if (ldapContext != null) {
			try {
				ldapContext.close();
			} catch (NamingException e) {
				e.printStackTrace();
				throw e;
			}

		}
	}

	public static void updateScheduledJobParameter(String jobName, String paramName, String paramValue,
			OIMClient oimClient) {
		SchedulerService schedulerService = null;

		try {
			// get scheduler service
			schedulerService = oimClient.getService(SchedulerService.class);

			JobDetails jbDetails = schedulerService.getJobDetail(jobName);

			HashMap jobAttributes = jbDetails.getAttributes();

			JobParameter jbParam = new JobParameter();
			jbParam.setName(paramName);
			jbParam.setValue(paramValue);

			jobAttributes.put(paramName, jbParam);

			jbDetails.setAttributes(jobAttributes);

			schedulerService.updateJob(jbDetails);

		} catch (Exception e) {
		}

	}
}
